<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BaseFarm Tracker - Airdrop Checklist</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        :root {
            --primary-color: #0052ff;
            --success-color: #28a745;
            --danger-color: #e53e3e;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
            --today-color: #0052ff;
            
            --background-color: #f0f4f8;
            --card-background: #ffffff;
            --card-secondary-bg: #f8fafc;
            --text-color: #1a202c;
            --subtle-text-color: #6b7280;
            --border-color: #e2e8f0;
            --hover-color: #eff6ff;
        }

        body.dark {
            --background-color: #111827;
            --card-background: #1f2937;
            --card-secondary-bg: #374151;
            --text-color: #f9fafb;
            --subtle-text-color: #9ca3af;
            --border-color: #4b5563;
            --hover-color: #374151;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            margin: 0;
            padding: 1rem;
            display: flex;
            align-items: flex-start;
            justify-content: center;
            min-height: 100vh;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        #root {
            width: 100%;
            display: flex;
            justify-content: center;
        }
        .app-container {
            width: 100%;
            max-width: 800px;
            background-color: var(--card-background);
            border-radius: 16px;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
            padding: 2rem;
            box-sizing: border-box;
            transition: background-color 0.3s ease;
        }
        .app-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 1rem;
            transition: border-color 0.3s ease;
        }
        .header-left {
             display: flex;
            align-items: center;
            gap: 1rem;
        }
        .app-header h1 {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
            margin: 0;
        }
        .header-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .icon-button {
            background: none;
            border: 1px solid var(--border-color);
            color: var(--subtle-text-color);
            width: 40px;
            height: 40px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s, color 0.2s;
        }
        .icon-button:hover {
            background-color: var(--card-secondary-bg);
            color: var(--text-color);
        }
        .small-icon-button {
             width: 36px;
            height: 36px;
        }
        .connectButton {
            background-color: var(--primary-color); color: white; border: none; padding: 0.75rem 1.25rem;
            border-radius: 8px; cursor: pointer; font-size: 0.9rem; font-weight: 600;
            transition: background-color 0.3s ease;
        }
        .connectButton:hover { background-color: #0045d1; }
        
        .profile-button { position: relative; }
        .profile-image {
            width: 40px; height: 40px; border-radius: 50%; cursor: pointer;
            border: 2px solid var(--border-color);
        }
        .profile-dropdown {
            position: absolute; top: 50px; right: 0; background-color: var(--card-background);
            border: 1px solid var(--border-color); border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            padding: 0.5rem; width: 200px; z-index: 10; display: none;
        }
        .profile-button:hover .profile-dropdown { display: block; }
        .profile-dropdown .info { padding: 0.5rem; border-bottom: 1px solid var(--border-color); }
        .profile-dropdown .username { font-weight: 600; }
        .profile-dropdown .address { font-size: 0.8rem; color: var(--subtle-text-color); word-break: break-all; }
        .profile-dropdown button {
            background: none; border: none; color: var(--danger-color); width: 100%;
            text-align: left; padding: 0.75rem; cursor: pointer; font-weight: 500; border-radius: 4px;
        }
        .profile-dropdown button:hover { background-color: var(--hover-color); }

        .top-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; gap: 1rem; }
        .data-controls { display: flex; gap: 0.5rem; }
        .sort-control select, .project-form input {
            padding: 0.75rem 1rem; border-radius: 8px; border: 1px solid var(--border-color);
            background-color: var(--card-background); color: var(--text-color);
            font-family: 'Inter', sans-serif; transition: all 0.3s ease;
        }
        .sort-control select { font-size: 0.9rem; height: 48px; }
        .project-form { display: flex; gap: 0.5rem; margin-bottom: 1.5rem; }
        .project-form input { flex-grow: 1; font-size: 1rem; }
        .project-form button {
            background-color: var(--primary-color); color: white; border: none;
            padding: 0 1.5rem; border-radius: 8px; font-weight: 600; cursor: pointer;
            transition: background-color 0.3s ease; display: flex; align-items: center; gap: 0.5rem;
        }
        .project-form button:hover { background-color: #0045d1; }

        .project-card {
            background-color: var(--card-secondary-bg); border: 1px solid var(--border-color);
            border-radius: 12px; margin-bottom: 1.5rem;
            transition: background-color 0.3s, border-color 0.3s;
        }
        .project-card-main { padding: 1.5rem; }
        .project-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; }
        .project-header h2 { margin: 0; font-size: 1.2rem; }
        .action-button { background: none; border: none; cursor: pointer; color: var(--subtle-text-color); transition: color 0.2s; padding: 0.25rem; }
        .action-button.delete:hover { color: var(--danger-color); }
        .action-button.edit:hover { color: var(--primary-color); }
        
        .progress-info { margin-bottom: 1rem; }
        .progress-text { font-size: 0.8rem; color: var(--subtle-text-color); margin-bottom: 0.25rem; }
        .progress-bar-container { width: 100%; background-color: var(--border-color); border-radius: 99px; height: 8px; overflow: hidden; transition: background-color 0.3s ease; }
        .progress-bar { height: 100%; background-color: var(--primary-color); border-radius: 99px; transition: width 0.5s ease; }
        
        .details-toggle {
            background: none; border: none; width: 100%; text-align: left; padding: 0.5rem 1.5rem;
            border-top: 1px solid var(--border-color); color: var(--subtle-text-color); cursor: pointer;
            display: flex; align-items: center; gap: 0.25rem; font-weight: 500;
        }
        .details-toggle svg { transition: transform 0.3s ease; }
        .details-toggle.open svg { transform: rotate(90deg); }
        .project-details { padding: 0 1.5rem; overflow: hidden; max-height: 0; transition: all 0.5s ease-in-out; }
        .project-details.open { max-height: 1000px; padding: 0 1.5rem 1.5rem 1.5rem; }
        .details-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        .details-grid label { font-size: 0.8rem; font-weight: 500; color: var(--subtle-text-color); margin-bottom: 0.25rem; display: block; }
        .details-grid input, .details-grid textarea {
            width: 100%; padding: 0.5rem 0.75rem; border: 1px solid var(--border-color); border-radius: 6px;
            font-size: 0.9rem; background-color: var(--card-background); color: var(--text-color);
            font-family: 'Inter', sans-serif; box-sizing: border-box;
        }
        .details-grid textarea { min-height: 80px; resize: vertical; }

        .task-list { list-style: none; padding: 0; margin: 0; }
        .task-item { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 0.5rem; flex-wrap: wrap; border-radius: 8px; transition: background-color 0.2s ease;}
        .task-item:hover { background-color: var(--hover-color); }
        .task-item-main { display: flex; align-items: center; flex-grow: 1; gap: 0.75rem; min-width: 200px; }
        .task-item input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; flex-shrink: 0; }
        .task-item label { flex-grow: 1; cursor: pointer; }
        .task-item label.completed { text-decoration: line-through; color: var(--subtle-text-color); }
        .task-item-actions { display: flex; align-items: center; gap: 0.5rem; }
        
        .priority-tag { font-size: 0.75rem; font-weight: 600; padding: 0.15rem 0.5rem; border-radius: 99px; text-transform: uppercase; }
        .priority-tag.high { background-color: #fed7d7; color: var(--danger-color); } body.dark .priority-tag.high { background-color: #5c1b1b; color: #fca5a5; }
        .priority-tag.medium { background-color: #feebc8; color: #b45309; } body.dark .priority-tag.medium { background-color: #78350f; color: #fcd34d; }
        .priority-tag.low { background-color: #bee3f8; color: #2b6cb0; } body.dark .priority-tag.low { background-color: #1e40af; color: #93c5fd; }

        .task-due-date { font-size: 0.8rem; font-weight: 500; padding: 0.2rem 0.5rem; border-radius: 4px; background-color: var(--border-color); color: var(--subtle-text-color); flex-shrink: 0; transition: background-color 0.3s, color 0.3s; }
        .task-due-date.overdue { background-color: #fed7d7; color: var(--danger-color); } body.dark .task-due-date.overdue { background-color: #5c1b1b; color: #fca5a5; }
        .task-due-date.today { background-color: #bee3f8; color: var(--today-color); } body.dark .task-due-date.today { background-color: #1e40af; color: #93c5fd; }
        
        .task-form, .edit-task-form { display: flex; gap: 0.5rem; margin-top: 1rem; flex-wrap: wrap; }
        .task-form input, .task-form select, .edit-task-form input { padding: 0.5rem 0.75rem; border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.9rem; background-color: var(--card-background); color: var(--text-color); font-family: 'Inter', sans-serif; transition: border-color 0.3s, background-color 0.3s; }
        .task-form input[type="text"], .edit-task-form input[type="text"] { flex-grow: 1; min-width: 150px; }
        .task-form button, .edit-task-form button { background-color: var(--success-color); color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; font-weight: 500; cursor: pointer; transition: background-color 0.3s ease; display: flex; align-items: center; gap: 0.25rem; }
        .task-form button:hover, .edit-task-form button:hover { background-color: #218838; }

        .completed-section-toggle { background: none; border: none; color: var(--subtle-text-color); cursor: pointer; font-weight: 500; padding: 0.5rem; display: flex; align-items: center; gap: 0.25rem; margin-top: 1rem; border-radius: 6px; transition: background-color 0.2s; }
        .completed-section-toggle:hover { background-color: var(--hover-color); }
        .completed-section-toggle svg { transition: transform 0.3s ease; }
        .completed-section-toggle.open svg { transform: rotate(90deg); }
        .completed-list { overflow: hidden; max-height: 0; transition: max-height 0.5s ease-in-out; }
        .completed-list.open { max-height: 1000px; }

        .notification { padding: 1rem; margin-bottom: 1.5rem; border-radius: 8px; font-weight: 500; text-align: center; }
        .notification.success { background-color: #e9f7ec; color: #155724; }
        .notification.error { background-color: #f8d7da; color: #721c24; }
        
        .modal-backdrop { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 100; backdrop-filter: blur(4px); }
        .modal-content { background-color: var(--card-background); padding: 2rem; border-radius: 16px; width: 90%; max-width: 400px; position: relative; }
        .modal-close { position: absolute; top: 1rem; right: 1rem; background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--subtle-text-color); }
        .modal-content h2 { margin-top: 0; }
        .wallet-options { display: flex; flex-direction: column; gap: 1rem; }
        .wallet-button {
            display: flex; align-items: center; gap: 1rem; padding: 1rem; border: 1px solid var(--border-color);
            border-radius: 8px; cursor: pointer; transition: background-color 0.2s; font-size: 1rem; font-weight: 600;
            background-color: var(--card-secondary-bg); color: var(--text-color); width: 100%;
        }
        .wallet-button:hover { background-color: var(--hover-color); }
        .wallet-button img { width: 32px; height: 32px; border-radius: 6px; }
        .wallet-button svg { width: 32px; height: 32px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="text/babel">
        function App() {
            const [user, setUser] = React.useState(null);
            const [notification, setNotification] = React.useState({ message: '', type: '' });
            const [theme, setTheme] = React.useState(() => localStorage.getItem('theme') || 'light');
            const [isModalOpen, setIsModalOpen] = React.useState(false);

            React.useEffect(() => {
                document.body.className = theme;
                localStorage.setItem('theme', theme);
            }, [theme]);
            
            React.useEffect(() => {
                const handleMessage = (event) => {
                    if (event.data.type === 'farcasterUserResponse') {
                        const { pfp, displayName, verifications } = event.data.user;
                        if (verifications && verifications.length > 0) {
                            setUser({ address: verifications[0], farcaster: { pfp, displayName } });
                            setIsModalOpen(false);
                            showNotification(`Welcome, ${displayName}!`, "success");
                        } else {
                            showNotification("Farcaster user has no verified address.", "error");
                        }
                    }
                };
                window.addEventListener('message', handleMessage);
                return () => window.removeEventListener('message', handleMessage);
            }, []);

            const toggleTheme = () => setTheme(prevTheme => (prevTheme === 'light' ? 'dark' : 'light'));

            const showNotification = (message, type = 'info') => {
                setNotification({ message, type });
                setTimeout(() => setNotification({ message: '', type: '' }), 4000);
            };

            const handleConnect = async (walletType) => {
                let provider;
                if (walletType === 'metamask' && window.ethereum) {
                    provider = window.ethereum;
                } else if (walletType === 'coinbase' && (window.coinbaseWalletExtension || window.ethereum?.providers?.find(p => p.isCoinbaseWallet))) {
                    provider = window.coinbaseWalletExtension || window.ethereum.providers.find(p => p.isCoinbaseWallet);
                } else {
                    provider = window.ethereum;
                }

                if (!provider) return showNotification("Selected wallet is not available.", "error");

                try {
                    const ethersProvider = new ethers.providers.Web3Provider(provider, "any");
                    await ethersProvider.send("eth_requestAccounts", []);
                    const signer = ethersProvider.getSigner();
                    const address = await signer.getAddress();
                    setUser({ address, farcaster: null });
                    setIsModalOpen(false);
                    showNotification("Wallet Connected! Your tracker is unlocked.", "success");
                } catch (err) {
                    console.error(err);
                    showNotification("Failed to connect wallet.", "error");
                }
            };
            
            const handleFarcasterConnect = () => {
                window.parent.postMessage({ type: 'farcasterUserRequest' }, '*');
            };

            const disconnectWallet = async () => {
                if (window.ethereum && window.ethereum.request) {
                    try {
                        await window.ethereum.request({ method: 'wallet_revokePermissions', params: [{ eth_accounts: {} }] });
                    } catch (err) { console.error("Could not revoke permissions:", err); }
                }
                setUser(null);
                showNotification("Disconnected.", "success");
            };
            
            return (
                <div className="app-container">
                    <div className="app-header">
                        <div className="header-left"><h1>BaseFarm Tracker</h1></div>
                        <div className="header-actions">
                            {user ? (
                                user.farcaster ? (
                                    <div className="profile-button">
                                        <img src={user.farcaster.pfp} alt="Farcaster PFP" className="profile-image" />
                                        <div className="profile-dropdown">
                                            <div className="info">
                                                <div className="username">{user.farcaster.displayName}</div>
                                                <div className="address">{`${user.address.substring(0, 6)}...${user.address.substring(user.address.length - 4)}`}</div>
                                            </div>
                                            <button onClick={disconnectWallet}>Disconnect</button>
                                        </div>
                                    </div>
                                ) : (
                                     <button className="connectButton disconnect" onClick={disconnectWallet}>
                                        {`${user.address.substring(0, 6)}...${user.address.substring(user.address.length - 4)}`}
                                    </button>
                                )
                            ) : (
                                <button className="connectButton" onClick={() => setIsModalOpen(true)}>
                                    Connect Wallet
                                </button>
                            )}
                            <button className="icon-button" onClick={toggleTheme} aria-label="Toggle theme">
                                {theme === 'light' ? <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg> : <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>}
                            </button>
                        </div>
                    </div>

                    {notification.message && <div className={`notification ${notification.type}`}>{notification.message}</div>}
                    
                    {user ? (
                        <FarmTracker userAddress={user.address} showNotification={showNotification}/>
                    ) : (
                        <div style={{ textAlign: 'center', padding: '2rem' }}>
                            <p>Please connect your wallet to manage your airdrop checklist.</p>
                        </div>
                    )}

                    {isModalOpen && <ConnectModal onClose={() => setIsModalOpen(false)} onConnect={handleConnect} onFarcasterConnect={handleFarcasterConnect} />}
                </div>
            );
        }

        const ConnectModal = ({ onClose, onConnect, onFarcasterConnect }) => (
            <div className="modal-backdrop">
                <div className="modal-content">
                    <button className="modal-close" onClick={onClose}>&times;</button>
                    <h2>Connect Wallet</h2>
                    <div className="wallet-options">
                         <button className="wallet-button" onClick={() => onConnect('metamask')}>
                            <img src="https://upload.wikimedia.org/wikipedia/commons/3/36/MetaMask_Fox.svg" alt="MetaMask Logo" />
                            <span>MetaMask</span>
                        </button>
                         <button className="wallet-button" onClick={() => onConnect('coinbase')}>
                            <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjQwIiBoZWlnaHQ9IjQwIiByeD0iMjAiIGZpbGw9IiMwMDUyRkYiLz4KPHBhdGggZmlsbC1ydWxlPSJldmVub2RkIiBjbGlwLXJ1bGU9ImV2ZW5vZGQiIGQ9Ik0xMiAxMkg4VjE2SDJWMTJWLDhDMiA0LjY4NjI5IDQuNjg2MjkgMiA4IDJWMkMxMiAyIDE2IDQuNjg2MjkgMTYgOEgxNlYxMkgxMlpNMTIgMjdIMTZWMzFIMTZWMzZDNS44MDIwMyAzNiAyNCAzMC4xOTggMjQgMjVWMTZIMTJWMTZWMjFIMTZWMjdIMTJaTTI3IDE2VjEySDI3VjhDMzAuMTk4IDggMzYgNS44MDIwMyAzNiAyIFYyQzQwLjE5OCAyIDQ0IDUuODAyMDMgNDQgOFYxMkM0NCAxNi4xOTggNDAuMTk4IDIwIDM2IDIwVjIwSDI3VjE2Wk0yNyAyN0gzMVYzMUgzNlYzNkMzMS44MDIgMzYgMjcgMzAuMTk4IDI3IDI1VjE2SDMxVjIxVjI3WiIgZmlsbD0id2hpdGUiIHRyYW5zZm9ybT0idHJhbnNsYXRlKC0yIC0yKSIvPgo8L3N2Zz4K" alt="Coinbase Wallet Logo" />
                            <span>Coinbase Wallet</span>
                        </button>
                        <button className="wallet-button" onClick={() => alert('Rabby Wallet support coming soon!')}>
                             <img src="https://static.debank.com/image/project/logo_url/rabby/28c113b284d3367a13c548f430543685.png" alt="Rabby Wallet Logo" />
                            <span>Rabby Wallet</span>
                        </button>
                        <button className="wallet-button" onClick={onFarcasterConnect}>
                            <svg viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg"><rect width="40" height="40" rx="20" fill="#8A63D2"></rect><path d="M26.25 10.75H13.75C12.925 10.75 12.25 11.425 12.25 12.25V27.75C12.25 28.575 12.925 29.25 13.75 29.25H26.25C27.075 29.25 27.75 28.575 27.75 27.75V12.25C27.75 11.425 27.075 10.75 26.25 10.75Z" stroke="white" strokeWidth="2.5"></path><path d="M26.25 14V13.75C26.25 12.925 25.575 12.25 24.75 12.25H15.25C14.425 12.25 13.75 12.925 13.75 13.75V26.25C13.75 27.075 14.425 27.75 15.25 27.75H24.75C25.575 27.75 26.25 27.075 26.25 26.25V14Z" fill="white"></path></svg>
                            <span>Sign in with Farcaster</span>
                        </button>
                    </div>
                </div>
            </div>
        );

        function FarmTracker({ userAddress, showNotification }) {
            const getStorageKey = React.useCallback((key) => `${key}-${userAddress}`, [userAddress]);
            
            const [projects, setProjects] = React.useState(() => {
                try {
                    const saved = localStorage.getItem(getStorageKey('farm-tracker'));
                    const parsedProjects = saved ? JSON.parse(saved) : [];
                    return parsedProjects.map(p => ({ ...p, details: p.details || { notes: '', website: '', twitter: '' } }));
                } catch (error) { return []; }
            });

            const [newProjectName, setNewProjectName] = React.useState('');
            const [sortMethod, setSortMethod] = React.useState('dateAdded');

            React.useEffect(() => {
                localStorage.setItem(getStorageKey('farm-tracker'), JSON.stringify(projects));
            }, [projects, getStorageKey]);
            
            // Notification logic...
            React.useEffect(() => { /* unchanged */ }, [projects, getStorageKey]);

            const addProject = (e) => {
                e.preventDefault();
                if (!newProjectName.trim()) return;
                const newProject = { 
                    id: Date.now(), name: newProjectName, tasks: [], 
                    details: { notes: '', website: '', twitter: '' } 
                };
                setProjects(prev => [newProject, ...prev]);
                setNewProjectName('');
            };
            
            const exportData = () => {
                const jsonString = `data:text/json;charset=utf-8,${encodeURIComponent(JSON.stringify(projects, null, 2))}`;
                const link = document.createElement("a");
                link.href = jsonString;
                link.download = `basetask_backup_${new Date().toISOString().slice(0, 10)}.json`;
                link.click();
            };
            const importData = (event) => {
                 const fileReader = new FileReader();
                fileReader.readAsText(event.target.files[0], "UTF-8");
                fileReader.onload = e => {
                    try {
                        const importedProjects = JSON.parse(e.target.result);
                        if (Array.isArray(importedProjects)) {
                             const migratedProjects = importedProjects.map(p => ({
                                ...p,
                                details: p.details || { notes: '', website: '', twitter: '' }
                            }));
                            setProjects(migratedProjects);
                            showNotification("Data imported successfully!", "success");
                        } else { throw new Error("Invalid file format"); }
                    } catch (error) { showNotification("Failed to import data. Invalid file.", "error"); }
                };
                 event.target.value = null;
            };

            const sortedProjects = React.useMemo(() => {
                const projectsCopy = [...projects];
                const getPriorityScore = (priority) => ({ high: 3, medium: 2, low: 1 }[priority] || 0);
                switch (sortMethod) {
                    case 'alphabetical': return projectsCopy.sort((a, b) => a.name.localeCompare(b.name));
                    case 'progress':
                        return projectsCopy.sort((a, b) => {
                            const progressA = a.tasks.length > 0 ? (a.tasks.filter(t => t.completed).length / a.tasks.length) * 100 : 0;
                            const progressB = b.tasks.length > 0 ? (b.tasks.filter(t => t.completed).length / b.tasks.length) * 100 : 0;
                            return progressB - progressA;
                        });
                    case 'priority':
                         return projectsCopy.sort((a, b) => {
                            const highA = Math.max(0, ...a.tasks.filter(t => !t.completed).map(t => getPriorityScore(t.priority)));
                            const highB = Math.max(0, ...b.tasks.filter(t => !t.completed).map(t => getPriorityScore(t.priority)));
                            return highB - highA;
                        });
                    case 'dateAdded': default: return projectsCopy.sort((a, b) => b.id - a.id);
                }
            }, [projects, sortMethod]);
            
            return (
                <div>
                    <div className="top-controls">
                        <div className="data-controls">
                             <input type="file" id="import-file" style={{ display: 'none' }} onChange={importData} accept=".json" />
                            <button className="icon-button small-icon-button" onClick={() => document.getElementById('import-file').click()} title="Import Data">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                            </button>
                            <button className="icon-button small-icon-button" onClick={exportData} title="Export Data">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                            </button>
                        </div>
                        <div className="sort-control">
                             <select value={sortMethod} onChange={(e) => setSortMethod(e.target.value)}>
                                <option value="dateAdded">Sort: Date Added</option>
                                <option value="alphabetical">Sort: A-Z</option>
                                <option value="progress">Sort: By Progress</option>
                                <option value="priority">Sort: By Priority</option>
                            </select>
                        </div>
                    </div>
                    <form className="project-form" onSubmit={addProject}>
                        <input type="text" placeholder="Add new project (e.g., Aerodrome Finance)" value={newProjectName} onChange={(e) => setNewProjectName(e.target.value)} />
                        <button type="submit">
                           <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                           Add Project
                        </button>
                    </form>
                    
                    {sortedProjects.map(project => (
                        <ProjectCard key={project.id} project={project} setProjects={setProjects} allProjects={projects} />
                    ))}
                    {sortedProjects.length === 0 && <p style={{textAlign: 'center', color: 'var(--subtle-text-color)'}}>No projects yet. Add one to start tracking!</p>}
                </div>
            );
        }

        function ProjectCard({ project, setProjects, allProjects }) {
            const [editingTaskId, setEditingTaskId] = React.useState(null);
            const [editingText, setEditingText] = React.useState('');
            const [newTaskInputs, setNewTaskInputs] = React.useState({ text: '', dueDate: '', priority: 'medium' });
            const [completedVisible, setCompletedVisible] = React.useState(false);
            const [detailsVisible, setDetailsVisible] = React.useState(false);

            const updateProject = (updatedData) => {
                setProjects(allProjects.map(p => p.id === project.id ? {...p, ...updatedData} : p));
            };
            const deleteProject = () => { if (confirm('...')) { setProjects(allProjects.filter(p => p.id !== project.id)); } };
            const handleTaskInputChange = (field, value) => setNewTaskInputs(prev => ({...prev, [field]: value }));
            const addTask = (e) => {
                e.preventDefault();
                const text = newTaskInputs.text || '';
                if (!text.trim()) return;
                const newTask = { id: Date.now(), text, dueDate: newTaskInputs.dueDate || '', priority: newTaskInputs.priority || 'medium', completed: false };
                updateProject({ tasks: [...project.tasks, newTask] });
                setNewTaskInputs({ text: '', dueDate: '', priority: 'medium' });
            };
            const handleDetailChange = (field, value) => {
                updateProject({ details: { ...project.details, [field]: value } });
            };
            const toggleTask = (taskId) => {
                updateProject({ tasks: project.tasks.map(t => t.id === taskId ? { ...t, completed: !t.completed } : t) });
            };
            const handleEdit = (task) => { setEditingTaskId(task.id); setEditingText(task.text); };
            const saveEdit = (taskId) => {
                updateProject({ tasks: project.tasks.map(t => t.id === taskId ? { ...t, text: editingText } : t) });
                setEditingTaskId(null); setEditingText('');
            };
            const formatDate = (dateString) => {
                if (!dateString) return '';
                const date = new Date(dateString);
                const userTimezoneOffset = date.getTimezoneOffset() * 60000;
                return new Date(date.getTime() + userTimezoneOffset).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            };
            const getDueDateClass = (task) => {
                if (!task.dueDate || task.completed) return '';
                const today = new Date(); today.setHours(0,0,0,0);
                const dueDate = new Date(task.dueDate); dueDate.setHours(0,0,0,0);
                if (dueDate < today) return 'overdue';
                if (dueDate.getTime() === today.getTime()) return 'today';
                return '';
            };

            const incompleteTasks = project.tasks.filter(t => !t.completed);
            const completedTasks = project.tasks.filter(t => t.completed);
            const progress = project.tasks.length > 0 ? (completedTasks.length / project.tasks.length) * 100 : 0;
            const PriorityTag = ({priority}) => (<span className={`priority-tag ${priority}`}>{priority}</span>);

            const TaskItem = ({ task }) => {
                const isEditing = editingTaskId === task.id;
                return (
                    <li className="task-item">
                        {isEditing ? (
                            <form className="edit-task-form" onSubmit={(e) => { e.preventDefault(); saveEdit(task.id); }}>
                                <input type="text" value={editingText} onChange={(e) => setEditingText(e.target.value)} autoFocus onBlur={() => saveEdit(task.id)}/>
                            </form>
                        ) : (
                            <>
                                <div className="task-item-main">
                                    <input type="checkbox" id={`task-${task.id}`} checked={task.completed} onChange={() => toggleTask(task.id)} />
                                    <label htmlFor={`task-${task.id}`} className={task.completed ? 'completed' : ''}> {task.text} </label>
                                </div>
                                <div className="task-item-actions">
                                    <PriorityTag priority={task.priority} />
                                    {task.dueDate && <span className={`task-due-date ${getDueDateClass(task)}`}> {formatDate(task.dueDate)} </span>}
                                    <button className="action-button edit" onClick={() => handleEdit(task)}>
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
                                    </button>
                                </div>
                            </>
                        )}
                    </li>
                );
            };

            return (
                 <div className="project-card">
                    <div className="project-card-main">
                        <div className="project-header">
                            <h2>{project.name}</h2>
                            <button className="action-button delete" onClick={deleteProject}>
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                            </button>
                        </div>
                        {project.tasks.length > 0 && (
                            <div className="progress-info">
                                <div className="progress-text">{completedTasks.length} of {project.tasks.length} tasks completed</div>
                                <div className="progress-bar-container"><div className="progress-bar" style={{width: `${progress}%`}}></div></div>
                            </div>
                        )}
                        <ul className="task-list">
                            {incompleteTasks.map(task => (<TaskItem key={task.id} task={task} />))}
                        </ul>
                        <form className="task-form" onSubmit={addTask}>
                            <input type="text" placeholder="Add new task (e.g., Swap to increase volume)" value={newTaskInputs.text || ''} onChange={(e) => handleTaskInputChange('text', e.target.value)} />
                            <input type="date" value={newTaskInputs.dueDate || ''} onChange={(e) => handleTaskInputChange('dueDate', e.target.value)} />
                            <select value={newTaskInputs.priority || 'medium'} onChange={(e) => handleTaskInputChange('priority', e.target.value)}>
                                <option value="low">Low</option>
                                <option value="medium">Medium</option>
                                <option value="high">High</option>
                            </select>
                            <button type="submit">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                                Add
                            </button>
                        </form>
                         {completedTasks.length > 0 && (
                            <>
                                <button className={`completed-section-toggle ${completedVisible ? 'open' : ''}`} onClick={() => setCompletedVisible(prev => !prev)}>
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
                                    {completedTasks.length} Completed Tasks
                                </button>
                                <div className={`completed-list ${completedVisible ? 'open' : ''}`}>
                                    <ul className="task-list">
                                        {completedTasks.map(task => (<TaskItem key={task.id} task={task} />))}
                                    </ul>
                                </div>
                            </>
                        )}
                    </div>
                    <button className={`details-toggle ${detailsVisible ? 'open' : ''}`} onClick={() => setDetailsVisible(prev => !prev)}>
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
                        Details
                    </button>
                    <div className={`project-details ${detailsVisible ? 'open' : ''}`}>
                        <div className="details-grid">
                            <div>
                                <label>Website</label>
                                <input type="text" placeholder="https://project.com" value={project.details?.website || ''} onChange={(e) => handleDetailChange('website', e.target.value)} />
                            </div>
                            <div>
                                <label>Twitter</label>
                                <input type="text" placeholder="https://twitter.com/project" value={project.details?.twitter || ''} onChange={(e) => handleDetailChange('twitter', e.target.value)} />
                            </div>
                            <div style={{gridColumn: '1 / -1'}}>
                                <label>Notes</label>
                                <textarea placeholder="Your strategy, thoughts, next steps..." value={project.details?.notes || ''} onChange={(e) => handleDetailChange('notes', e.target.value)}></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }
        
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>

